#!/usr/bin/env bash

set -e

if [[ -z "$(gcloud config list --format='value(core.account)')" ]]; then
  echo 'Must log in using `gcloud auth login`'
  exit 1
fi

CONCOURSE_DEPLOYMENT=${CONCOURSE_DEPLOYMENT:-$HOME/workspace/concourse-bosh-deployment}
if [[ ! -d $CONCOURSE_DEPLOYMENT ]]; then
 pushd $HOME/workspace
  git clone https://github.com/concourse/concourse-bosh-deployment
 popd
else
  pushd $CONCOURSE_DEPLOYMENT
    git pull
  popd
fi

GARDEN_WINDOWS_CI=${GARDEN_WINDOWS_CI:-$HOME/workspace/garden-windows-ci}
if [[ ! -d $GARDEN_WINDOWS_CI ]]; then
 pushd $HOME/workspace
  git clone git@github.com:cloudfoundry/garden-windows-ci
 popd
fi

source $GARDEN_WINDOWS_CI/bin/bash_helpers

concourse_vars_project="cf-greenhouse-spitfire"

DIR=$(mktemp -d)
gsutil cp gs://$concourse_vars_project/concourse/creds.yml $DIR/creds.yml

bosh_target "spitfire"
bosh -d concourse deploy ${CONCOURSE_DEPLOYMENT}/cluster/concourse.yml \
  -v deployment_name=concourse \
  -o ${CONCOURSE_DEPLOYMENT}/cluster/operations/external-postgres.yml \
  -o ${CONCOURSE_DEPLOYMENT}/cluster/operations/external-postgres-tls.yml \
  -o ${CONCOURSE_DEPLOYMENT}/cluster/operations/external-postgres-client-cert.yml \
  -o ${CONCOURSE_DEPLOYMENT}/cluster/operations/github-auth.yml  \
  -o ${CONCOURSE_DEPLOYMENT}/cluster/operations/scale.yml \
  -o ${CONCOURSE_DEPLOYMENT}/cluster/operations/windows-worker.yml \
  -o ${CONCOURSE_DEPLOYMENT}/cluster/operations/windows-worker-ephemeral-disk.yml \
  -o ${CONCOURSE_DEPLOYMENT}/cluster/operations/worker-ephemeral-disk.yml \
  -o ${CONCOURSE_DEPLOYMENT}/cluster/operations/tls.yml \
  -o ${CONCOURSE_DEPLOYMENT}/cluster/operations/privileged-https.yml \
  -o ${CONCOURSE_DEPLOYMENT}/cluster/operations/storage-driver.yml \
  -o ${GARDEN_WINDOWS_CI}/operations/concourse/web-network.yml \
  -o ${GARDEN_WINDOWS_CI}/operations/concourse/windows-tools-1709.yml \
  -o ${GARDEN_WINDOWS_CI}/operations/concourse/use-1709-windows2016-stemcell.yml \
  -o ${GARDEN_WINDOWS_CI}/operations/concourse/windows-bosh-ssh.yml \
  -o ${GARDEN_WINDOWS_CI}/operations/concourse/linux-worker-garden-dns-servers.yml \
  -l ${CONCOURSE_DEPLOYMENT}/versions.yml \
  -l <(gsutil cat gs://$concourse_vars_project/concourse/vars.yml) \
  -v storage_driver=overlay \
  --vars-store $DIR/creds.yml

gsutil cp $DIR/creds.yml gs://$concourse_vars_project/concourse/creds.yml

bosh -d concourse-worker-1803 deploy ${CONCOURSE_DEPLOYMENT}/cluster/external-worker.yml \
  -v deployment_name=concourse-worker-1803 \
  -o ${CONCOURSE_DEPLOYMENT}/cluster/operations/worker-ephemeral-disk.yml \
  -o ${CONCOURSE_DEPLOYMENT}/cluster/operations/windows-worker.yml \
  -o ${CONCOURSE_DEPLOYMENT}/cluster/operations/windows-worker-ephemeral-disk.yml \
  -o ${GARDEN_WINDOWS_CI}/operations/concourse/remove-linux-external-worker.yml \
  -o ${GARDEN_WINDOWS_CI}/operations/concourse/windows-worker-tags.yml \
  -o ${GARDEN_WINDOWS_CI}/operations/concourse/windows-worker-external.yml \
  -o ${GARDEN_WINDOWS_CI}/operations/concourse/windows-tools-1803.yml \
  -o ${GARDEN_WINDOWS_CI}/operations/concourse/use-1803-windows2016-stemcell.yml \
  -o ${GARDEN_WINDOWS_CI}/operations/concourse/windows-bosh-ssh.yml \
  -v windows_worker_tag=1803 \
  -l ${CONCOURSE_DEPLOYMENT}/versions.yml \
  -l <(gsutil cat gs://$concourse_vars_project/concourse/vars.yml) \
  -l $DIR/creds.yml

bosh -d concourse-worker-2019 deploy ${CONCOURSE_DEPLOYMENT}/cluster/external-worker.yml \
  -v deployment_name=concourse-worker-2019 \
  -o ${CONCOURSE_DEPLOYMENT}/cluster/operations/worker-ephemeral-disk.yml \
  -o ${CONCOURSE_DEPLOYMENT}/cluster/operations/windows-worker.yml \
  -o ${CONCOURSE_DEPLOYMENT}/cluster/operations/windows-worker-ephemeral-disk.yml \
  -o ${GARDEN_WINDOWS_CI}/operations/concourse/remove-linux-external-worker.yml \
  -o ${GARDEN_WINDOWS_CI}/operations/concourse/windows-worker-tags.yml \
  -o ${GARDEN_WINDOWS_CI}/operations/concourse/windows-worker-external.yml \
  -o ${GARDEN_WINDOWS_CI}/operations/concourse/windows-tools-2019.yml \
  -o ${GARDEN_WINDOWS_CI}/operations/concourse/use-windows2019-stemcell.yml \
  -o ${GARDEN_WINDOWS_CI}/operations/concourse/windows-bosh-ssh.yml \
  -v windows_worker_tag=2019 \
  -l ${CONCOURSE_DEPLOYMENT}/versions.yml \
  -l <(gsutil cat gs://$concourse_vars_project/concourse/vars.yml) \
  -l $DIR/creds.yml

bosh -d concourse-worker-envoy deploy ${CONCOURSE_DEPLOYMENT}/cluster/external-worker.yml \
  -v deployment_name=concourse-worker-envoy \
  -o ${CONCOURSE_DEPLOYMENT}/cluster/operations/worker-ephemeral-disk.yml \
  -o ${CONCOURSE_DEPLOYMENT}/cluster/operations/windows-worker.yml \
  -o ${CONCOURSE_DEPLOYMENT}/cluster/operations/windows-worker-ephemeral-disk.yml \
  -o ${GARDEN_WINDOWS_CI}/operations/concourse/remove-linux-external-worker.yml \
  -o ${GARDEN_WINDOWS_CI}/operations/concourse/windows-worker-tags.yml \
  -o ${GARDEN_WINDOWS_CI}/operations/concourse/windows-worker-external.yml \
  -o ${GARDEN_WINDOWS_CI}/operations/concourse/windows-tools-envoy-1803.yml \
  -o ${GARDEN_WINDOWS_CI}/operations/concourse/use-1803.1-windows2016-stemcell.yml \
  -o ${GARDEN_WINDOWS_CI}/operations/concourse/windows-bosh-ssh.yml \
  -o ${GARDEN_WINDOWS_CI}/operations/concourse/envoy-vmtype.yml \
  -v windows_worker_tag=envoy \
  -l ${CONCOURSE_DEPLOYMENT}/versions.yml \
  -l <(gsutil cat gs://$concourse_vars_project/concourse/vars.yml) \
  -l $DIR/creds.yml

# mulgore is our vsphere environment.
# we need a linux worker for concourse GETs and windows worker for running tests.
bosh_target "mulgore"
bosh -d concourse-worker-1903 deploy ${CONCOURSE_DEPLOYMENT}/cluster/external-worker.yml \
  -v deployment_name=concourse-worker-1903 \
  -o ${CONCOURSE_DEPLOYMENT}/cluster/operations/worker-ephemeral-disk.yml \
  -o ${CONCOURSE_DEPLOYMENT}/cluster/operations/windows-worker.yml \
  -o ${CONCOURSE_DEPLOYMENT}/cluster/operations/windows-worker-ephemeral-disk.yml \
  -o ${CONCOURSE_DEPLOYMENT}/cluster/operations/storage-driver.yml \
  -o ${GARDEN_WINDOWS_CI}/operations/concourse/windows-worker-tags.yml \
  -o ${GARDEN_WINDOWS_CI}/operations/concourse/windows-worker-network.yml \
  -o ${GARDEN_WINDOWS_CI}/operations/concourse/windows-worker-external.yml \
  -o ${GARDEN_WINDOWS_CI}/operations/concourse/windows-tools-2019.yml \
  -o ${GARDEN_WINDOWS_CI}/operations/concourse/use-windows1903-stemcell.yml \
  -o ${GARDEN_WINDOWS_CI}/operations/concourse/windows-bosh-ssh-1903.yml \
  -o ${GARDEN_WINDOWS_CI}/operations/enable-rdp-1903.yml \
  -o ${GARDEN_WINDOWS_CI}/operations/concourse/scale-linux-worker.yml \
  -v windows_worker_tag=1903 \
  -v storage_driver=overlay \
  -l ${CONCOURSE_DEPLOYMENT}/versions.yml \
  -l <(gsutil cat gs://$concourse_vars_project/concourse/vars.yml) \
  -v worker_instances=2 \
  -l $DIR/creds.yml

rm $DIR/creds.yml

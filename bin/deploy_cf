#!/bin/bash

set -e


if [ "$BOSH_TARGET_NAME" != "$1" ]; then
  echo "Current bosh target is \"$BOSH_TARGET_NAME\". Please 'bt $1' and run the script again"
  exit 1
fi
if [[ -z "$(gcloud config list --format='value(core.account)')" ]]; then
  echo 'Must log in using `gcloud auth login`'
  exit 1
fi

envs_dir="/tmp/garden-windows-environments"

if [ -d "${envs_dir}" ]; then
  # Ensure we have the latest version of the environments repo.
  rm -rf "${envs_dir}"
fi

mkdir -p "${envs_dir}" &> /dev/null
git clone git@github.com:pivotal/garden-windows-environments.git ${envs_dir} &> /dev/null
if [ $? -ne 0 ]; then
  echo "'git clone git@github.com:pivotal/garden-windows-environments.git' failed; make sure to run 'load-key'"
  return 1
fi

environment=$1
case "$1" in
  hummus | alfredo)
    ;;
  *)
    echo "Cannot deploy environment: $1"
    exit 1
esac

echo "deploying $environment..."
CF_DEPLOYMENT=${CF_DEPLOYMENT:-$HOME/workspace/cf-deployment}
GARDEN_WINDOWS_CI=${GARDEN_WINDOWS_CI:-$HOME/workspace/garden-windows-ci}

if [[ ! -d "${CF_DEPLOYMENT}" ]]; then
  git clone https://github.com/cloudfoundry/cf-deployment ${CF_DEPLOYMENT}
else
  pushd ${CF_DEPLOYMENT} > /dev/null
    git pull
  popd > /dev/null
fi

command="bosh -d cf deploy ${CF_DEPLOYMENT}/cf-deployment.yml \
    -o ${CF_DEPLOYMENT}/operations/scale-to-one-az.yml \
    -o ${CF_DEPLOYMENT}/operations/stop-skipping-tls-validation.yml \
    -o ${GARDEN_WINDOWS_CI}/operations/use-2-azs-for-router.yml \
    -o ${GARDEN_WINDOWS_CI}/operations/latest-winc.yml \
    -v system_domain=$environment.cf-app.com \
    --skip-drain \
  "

# To add a 2012R2 cell, uncomment this block
#command="$command -o ${CF_DEPLOYMENT}/operations/windows2012R2-cell.yml \
#    -o ${CF_DEPLOYMENT}/operations/use-latest-windows2012R2-stemcell.yml \
#    -o ${GARDEN_WINDOWS_CI}/operations/enable-rdp-2012R2.yml \
#  "

if [ "$2" = "1803" ]; then
  command="$command -o ${CF_DEPLOYMENT}/operations/windows1803-cell.yml \
    -o ${GARDEN_WINDOWS_CI}/operations/enable-rdp-1803.yml \
    -o ${GARDEN_WINDOWS_CI}/operations/windows1803-debug.yml \
    -o ${CF_DEPLOYMENT}/operations/use-latest-windows1803-stemcell.yml \
    "
elif [ "$2" = "2019" ]; then
  command="$command -o ${CF_DEPLOYMENT}/operations/windows2019-cell.yml \
    -o ${CF_DEPLOYMENT}/operations/use-online-windows2019fs.yml \
    -o ${GARDEN_WINDOWS_CI}/operations/enable-rdp-2019.yml \
    -o ${GARDEN_WINDOWS_CI}/operations/windows2019-debug.yml \
    -o ${CF_DEPLOYMENT}/operations/use-latest-windows2019-stemcell.yml \
    "
else
  echo "Invalid version, please select 1803 or 2019"
  exit 1
fi

echo "Deploying cf on $environment"

command="$command \
  -v system_domain=$environment.cf-app.com \
  -l $envs_dir/$environment/cf/vars.yml
  "

eval $command
#rm -rf $envs_dir

#!/usr/bin/env bash

# 1. Check lock
# 2. If already locked exit
# 3. else acquire lock
# 4. bbl destroy
# 5. run bbl up script
# 6. release lock
set -eux

release_lock() {
  if [ -f ci-lock/$env/unclaimed/$env ]; then
    echo "$env is already unclaimed. Exiting"
    return 0
  fi

  git mv ci-lock/$env/claimed/$env ci-lock/$env/unclaimed/$env
  git commit -c user.name="Garden Windows CI" -c user.email=<> commit --author "environments-pipeline <>" -m "environments/bbl-update-$env unclaiming: $env"
  git push origin master
  echo Released $env
}

get_lock_or_die() {
  if [ -f ci-lock/$env/claimed/$env ]; then
    echo "$env is claimed. Exiting"
    exit 0
  fi
  git mv ci-lock/$env/unclaimed/$env ci-lock/$env/claimed/$env
  git commit -c user.name="Garden Windows CI" -c user.email=<> commit --author "environments-pipeline <>" -m "environments/bbl-update-$env claiming: $env"
  git push origin master
  echo Claimed $env
}

get_lock_or_die
release_lock
bbl=binary-dir/bbl_executable



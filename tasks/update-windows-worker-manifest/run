#!/usr/bin/env bash

set -eu

ops="
---
- type: replace
  path: /stemcells/alias=windows/version
  value: "$(< windows-2019-stemcell/version)"
"

eval "$(bbl --state-dir=garden-windows-environments/spitfire print-env)"
bosh -d ${BOSH_DEPLOYMENT} manifest > artifacts/manifest.yml.OLD
bosh int artifacts/manifest.yml.OLD -o <(echo "${ops}") > artifacts/manifest.yml

echo -n "${BOSH_CREDENTIALS}" > artifacts/source-file.yml
echo -n "${BOSH_DEPLOYMENT}" >> artifacts/source-file.yml
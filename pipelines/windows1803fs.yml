groups:
- name: ((fs-version))
  jobs:
    - bump-windowsfs-release-windows2016fs
    - bump-windowsfs-online-release-windows2016fs
    - bump-windowsfs-release-hydrator
    - bump-windowsfs-online-release-hydrator
    - bump-go-online
    - bump-go-offline
    - create-tracker-story
- name: windowsfs-release
  jobs:
    - test-create-release-windows
    - test-create-release-linux
    - tartar-offline-cats
    - tartar-offline-smoke-test
    - shipit-offline-major
    - shipit-offline-minor
    - shipit-offline-patch
- name: windowsfs-online-release
  jobs:
    - tartar-online-cats
    - tartar-online-smoke-test
    - shipit-online-major
    - shipit-online-minor
    - shipit-online-patch

resource_types:
- name: bosh-deployment
  type: docker-image
  source:
    repository: cloudfoundry/bosh-deployment-resource

resources:

# Git

- name: ci
  type: git
  source:
    branch: master
    uri: https://github.com/cloudfoundry/garden-windows-ci.git

- name: windowsfs-release-develop
  type: git
  source:
    branch: develop
    uri: ((windowsfs-release-develop-uri))
    private_key: ((GREENHOUSE-CI_SSH_KEY))
    git_config:
    - name: user.email
      value: "pivotal-netgarden-eng@pivotal.io"
    - name: user.name
      value: "Greenhouse CI"

- name: windowsfs-release-master
  type: git
  source:
    branch: master
    uri: ((windowsfs-release-master-uri))
    private_key: ((GREENHOUSE-CI_SSH_KEY))

- name: windowsfs-online-release-develop
  type: git
  source:
    branch: develop
    uri: ((windowsfs-online-release-develop-uri))
    private_key: ((GREENHOUSE-CI_SSH_KEY))
    git_config:
    - name: user.email
      value: "pivotal-netgarden-eng@pivotal.io"
    - name: user.name
      value: "Greenhouse CI"

- name: windowsfs-online-release-master
  type: git
  source:
    branch: master
    uri: ((windowsfs-online-release-master-uri))
    private_key: ((GREENHOUSE-CI_SSH_KEY))

- name: hydrator
  type: git
  source:
    branch: master
    uri: git@github.com:cloudfoundry/hydrator.git
    private_key: ((CLOUDFOUNDRY_HYDRATOR_DEPLOY_KEY))

- name: windows2016fs
  type: git
  source:
    branch: master
    uri: git@github.com:cloudfoundry/windows2016fs.git
    private_key: ((CLOUDFOUNDRYINCUBATOR_WINDOWS2016FS_DEPLOY_KEY))
    ignore_paths: [ ((os-version))/Dockerfile ]

- name: cf-acceptance-tests
  type: git
  source:
    branch: master
    uri: https://github.com/cloudfoundry/cf-acceptance-tests

- name: cf-deployment-concourse-tasks
  type: git
  source:
    branch: master
    uri: https://github.com/cloudfoundry/cf-deployment-concourse-tasks.git

- name: cf-deployment
  type: git
  source:
    branch: release-candidate
    uri: https://github.com/cloudfoundry/cf-deployment.git

- name: winc-release-master
  type: git
  source:
    branch: master
    uri: https://github.com/cloudfoundry/winc-release.git

- name: garden-windows-environments
  type: git
  source:
    branch: master
    private_key: ((GREENHOUSE-CI_SSH_KEY))
    uri: git@github.com:pivotal/garden-windows-environments

# GitHub Release

- name: windowsfs-release-github-release
  type: github-release
  source:
    user: cloudfoundry
    repository: ((windowsfs-release-repo))
    drafts: true
    access_token: ((GREENHOUSE_CI_ACCESS_TOKEN))

- name: windowsfs-online-release-github-release
  type: github-release
  source:
    user: cloudfoundry
    repository: ((windowsfs-online-release-repo))
    drafts: true
    access_token: ((GREENHOUSE_CI_ACCESS_TOKEN))

- name: golang-release
  type: git
  source:
    uri: https://github.com/bosh-packages/golang-release.git
    tag_filter: v*

# S3

- name: gcp-windows-stemcell
  type: s3
  source:
    bucket: all-bosh-windows
    regexp: ((stemcell-regexp))
    access_key_id: ((BOSH_WINDOWS_BOSH_CI_S3_ACCESS_KEY_ID))
    secret_access_key: ((BOSH_WINDOWS_BOSH_CI_S3_SECRET_ACCESS_KEY))

# Semver

- name: windowsfs-release-version
  type: semver
  source:
    access_key_id: ((BOSH_WINDOWS_S3_ADMIN_ACCESS_KEY_ID))
    secret_access_key: ((BOSH_WINDOWS_S3_ADMIN_SECRET_ACCESS_KEY))
    bucket: ((fs-version))
    initial_version: ((initial-release-version))
    key: windowsfs-release-version
    region_name: us-east-1

- name: windowsfs-online-release-version
  type: semver
  source:
    access_key_id: ((BOSH_WINDOWS_S3_ADMIN_ACCESS_KEY_ID))
    secret_access_key: ((BOSH_WINDOWS_S3_ADMIN_SECRET_ACCESS_KEY))
    bucket: ((fs-version))
    initial_version: ((initial-online-release-version))
    key: windowsfs-online-release-version
    region_name: us-east-1

- name: image-version
  type: semver
  source:
    access_key_id: ((BOSH_WINDOWS_S3_ADMIN_ACCESS_KEY_ID))
    secret_access_key: ((BOSH_WINDOWS_S3_ADMIN_SECRET_ACCESS_KEY))
    bucket: ((fs-version))
    initial_version: ((initial-image-version))
    key: image-version
    region_name: us-east-1


# BOSH Deployment

- name: tartar-cf-deployment
  type: bosh-deployment
  source:
    deployment: cf
    client: ((TARTAR_BOSH_CLIENT))
    client_secret: ((TARTAR_BOSH_CLIENT_SECRET))
    ca_cert: ((TARTAR_BOSH_CA_CERT))
    target: ((TARTAR_BOSH_ENVIRONMENT))
    jumpbox_url: ((TARTAR_JUMPBOX_URL))
    jumpbox_ssh_key: ((TARTAR_JUMPBOX_SSH_KEY))

- name: tartar-smoke-test-deployment
  type: bosh-deployment
  source:
    deployment: ((fs-version))
    client: ((TARTAR_BOSH_CLIENT))
    client_secret: ((TARTAR_BOSH_CLIENT_SECRET))
    ca_cert: ((TARTAR_BOSH_CA_CERT))
    target: ((TARTAR_BOSH_ENVIRONMENT))
    jumpbox_url: ((TARTAR_JUMPBOX_URL))
    jumpbox_ssh_key: ((TARTAR_JUMPBOX_SSH_KEY))

# Lock Pool

- name: tartar-lock-pool
  type: pool
  source:
    branch: master
    pool: tartar
    private_key: ((GREENHOUSE-CI_SSH_KEY))
    uri: git@github.com:greenhouse-ci/locks

jobs:
- name: create-tracker-story
  serial: true
  plan:
  - in_parallel:
    - get: ci
    - get: image-version
      trigger: true
  - task: create-story
    file: ci/tasks/create-rootfs-tracker-story/task.yml
    input_mapping:
      version: image-version
    params:
      TRACKER_TOKEN: ((TRACKER_GITBOT_TOKEN))
      TRACKER_PROJECT_ID: "((DOTNET_DEVX_PROJECT_ID))"
      FS_VERSION: ((fs-version))

- name: bump-windowsfs-release-windows2016fs
  serial: true
  plan:
  - in_parallel:
    - get: ci
    - get: windowsfs-release-develop
    - get: windows2016fs
      trigger: true
  - task: bump-windowsfs-release
    file: ci/tasks/bump-submodule/task.yml
    params:
      SUBMODULE: "src/code.cloudfoundry.org/windows2016fs"
    input_mapping:
      source-repo: windowsfs-release-develop
      module-repo: windows2016fs
  - task: update-blob
    file: ci/tasks/update-windows2016fs-blob/task.yml
    params:
      FS_VERSION: ((fs-version))
      OS_VERSION: "((os-version))"
    input_mapping:
      windowsfs-release: bumped-repo
  - task: commit-changes
    file: ci/tasks/commit/task.yml
    input_mapping:
      repo: windowsfs-release-updated-blob
    output_mapping:
      repo_with_commit: windowsfs-release-updated-commit
    params:
      MESSAGE: "Updated image blob"
  - put: windowsfs-release-develop
    params:
      repository: windowsfs-release-updated-commit
      rebase: false

- name: bump-windowsfs-release-hydrator
  serial: true
  plan:
  - in_parallel:
    - get: ci
    - get: windowsfs-release-develop
    - get: hydrator
      trigger: true
  - task: bump-windowsfs-release
    file: ci/tasks/bump-submodule/task.yml
    params:
      SUBMODULE: "src/code.cloudfoundry.org/hydrator"
    input_mapping:
      source-repo: windowsfs-release-develop
      module-repo: hydrator
  - put: windowsfs-release-develop
    params:
      repository: bumped-repo
      rebase: false

- name: bump-windowsfs-online-release-windows2016fs
  serial: true
  plan:
  - in_parallel:
    - get: ci
    - get: windowsfs-online-release-develop
    - get: windows2016fs
      trigger: true
  - task: bump-windowsfs-online-release
    file: ci/tasks/bump-submodule/task.yml
    params:
      SUBMODULE: "src/code.cloudfoundry.org/windows2016fs"
    input_mapping:
      source-repo: windowsfs-online-release-develop
      module-repo: windows2016fs
  - put: windowsfs-online-release-develop
    params:
      repository: bumped-repo
      rebase: true

- name: bump-windowsfs-online-release-hydrator
  serial: true
  plan:
  - in_parallel:
    - get: ci
    - get: windowsfs-online-release-develop
    - get: hydrator
      trigger: true
  - task: bump-windowsfs-online-release
    file: ci/tasks/bump-submodule/task.yml
    params:
      SUBMODULE: "src/code.cloudfoundry.org/hydrator"
    input_mapping:
      source-repo: windowsfs-online-release-develop
      module-repo: hydrator
  - put: windowsfs-online-release-develop
    params:
      repository: bumped-repo
      rebase: true

- name: bump-go-online
  serial: true
  plan:
  - in_parallel:
    - get: golang-release
      trigger: true
    - get: windowsfs-online-release-develop
    - get: ci
  - task: bosh-vendor-package
    file: ci/tasks/bosh-vendor-package/task.yml
    params:
      AWS_ACCESS_KEY_ID: {{BOSH_WINDOWS_BOSH_CI_S3_ACCESS_KEY_ID}}
      AWS_SECRET_ACCESS_KEY: {{BOSH_WINDOWS_BOSH_CI_S3_SECRET_ACCESS_KEY}}
      PACKAGE: golang-1-windows
    input_mapping:
      release-repo: windowsfs-online-release-develop
      package-repo: golang-release
  - put: windowsfs-online-release-develop
    params:
      repository: bumped-release-repo

- name: bump-go-offline
  serial: true
  plan:
  - in_parallel:
    # We don't use this release, but it should get triggered when there is a golang bump
    - get: golang-release
      trigger: true
    - get: windowsfs-release-develop
    - get: ci
  - task: bosh-update-blob
    file: ci/tasks/bosh-update-blob/task.yml
    params:
      AWS_ACCESS_KEY_ID: {{BOSH_WINDOWS_BOSH_CI_S3_ACCESS_KEY_ID}}
      AWS_SECRET_ACCESS_KEY: {{BOSH_WINDOWS_BOSH_CI_S3_SECRET_ACCESS_KEY}}
    input_mapping:
      release-repo: windowsfs-release-develop
  - put: windowsfs-release-develop
    params:
      repository: bumped-release-repo

- name: test-create-release-windows
  serial: true
  plan:
  - in_parallel:
    - get: ci
    - get: windowsfs-release-develop
      trigger: true
  - in_parallel:
    - task: create-dev-release
      tags: ["1803"]
      file: ci/tasks/create-fs-release-windows/task.yml
      input_mapping:
        windowsfs-release: windowsfs-release-develop
      params:
        EPHEMERAL_DISK_TEMP_PATH: "C:\\var\\vcap\\data\\tmp"
    - task: run-ginkgo-exe
      tags: ["1803"]
      file: ci/tasks/ginkgo-from-gopath-windows/task.yml
      input_mapping: { repo: windowsfs-release-develop}
      params:
        TEST_PATH: src/create
        EPHEMERAL_DISK_TEMP_PATH: "C:\\var\\vcap\\data\\tmp"

- name: test-create-release-linux
  serial: true
  plan:
  - in_parallel:
    - get: ci
    - get: windowsfs-release-develop
      trigger: true
  - in_parallel:
    - task: create-dev-release
      file: ci/tasks/create-fs-release-linux/task.yml
      input_mapping:
        windowsfs-release: windowsfs-release-develop
    - task: run-ginkgo
      file: ci/tasks/ginkgo-from-gopath-linux/task.yml
      input_mapping: { repo: windowsfs-release-develop}
      params:
        TEST_PATH: src/create

- name: tartar-offline-cats
  serial: true
  plan:
  - put: tartar-lock-pool
    params:
      acquire: true
  - in_parallel:
    - get: ci
    - get: windowsfs-release-develop
      passed: [test-create-release-windows, test-create-release-linux]
      trigger: true
    - get: cf-acceptance-tests
    - get: cf-deployment-concourse-tasks
    - get: cf-deployment
    - get: gcp-windows-stemcell
    - get: garden-windows-environments
  - in_parallel:
    - task: get-linux-stemcell
      file: ci/tasks/get-gcp-linux-stemcell/task.yml
      output_mapping: { stemcell: gcp-linux-stemcell }
    - task: create-windowsfs-release
      file: ci/tasks/create-fs-release-linux/task.yml
      input_mapping:
        windowsfs-release: windowsfs-release-develop
      output_mapping:
        release-tarball: windowsfs-tarball
  - task: create-windowsfs-opsfile
    file: ci/tasks/write-windows2016fs-opsfile/task.yml
    params:
      FS_VERSION: ((fs-version))
    input_mapping: { release-tarball: windowsfs-tarball }
  - task: delete-deployments
    file: ci/tasks/bosh-delete-deployments/task.yml
    params:
      BOSH_CA_CERT: ((TARTAR_BOSH_CA_CERT))
      BOSH_CLIENT: ((TARTAR_BOSH_CLIENT))
      BOSH_CLIENT_SECRET: ((TARTAR_BOSH_CLIENT_SECRET))
      BOSH_ENVIRONMENT: ((TARTAR_BOSH_ENVIRONMENT))
      JUMPBOX_IP: ((TARTAR_JUMPBOX_IP))
      JUMPBOX_SSH_KEY: ((TARTAR_JUMPBOX_SSH_KEY))
  - task: delete-stemcells
    file: ci/tasks/bosh-delete-stemcells/task.yml
    params:
      BOSH_CA_CERT: ((TARTAR_BOSH_CA_CERT))
      BOSH_CLIENT: ((TARTAR_BOSH_CLIENT))
      BOSH_CLIENT_SECRET: ((TARTAR_BOSH_CLIENT_SECRET))
      BOSH_DEPLOYMENT: cf
      BOSH_ENVIRONMENT: ((TARTAR_BOSH_ENVIRONMENT))
      JUMPBOX_IP: ((TARTAR_JUMPBOX_IP))
      JUMPBOX_SSH_KEY: ((TARTAR_JUMPBOX_SSH_KEY))
  - task: delete-rootfs-release
    file: ci/tasks/bosh-delete-release/task.yml
    params:
      FS_VERSION: ((fs-version))
      BOSH_CA_CERT: ((TARTAR_BOSH_CA_CERT))
      BOSH_CLIENT: ((TARTAR_BOSH_CLIENT))
      BOSH_CLIENT_SECRET: ((TARTAR_BOSH_CLIENT_SECRET))
      BOSH_DEPLOYMENT: cf
      BOSH_ENVIRONMENT: ((TARTAR_BOSH_ENVIRONMENT))
      JUMPBOX_IP: ((TARTAR_JUMPBOX_IP))
      JUMPBOX_SSH_KEY: ((TARTAR_JUMPBOX_SSH_KEY))
  - put: tartar-cf-deployment
    params:
      manifest: cf-deployment/cf-deployment.yml
      stemcells:
      - gcp-linux-stemcell/*.tgz
      - gcp-windows-stemcell/*.tgz
      releases:
      - windowsfs-tarball/*.tgz
      ops_files:
      - cf-deployment/operations/scale-to-one-az.yml
      - ci/operations/use-2-azs-for-router.yml
      - ((windows-cell-ops-file))
      - ((latest-windows-stemcell-ops-file))
      - ((windows-scale-down-ops-file))
      - ((windows-rdp-ops-file))
      - windowsfs-opsfile/specified-windowsfs-version.yml
      vars_files:
      - garden-windows-environments/tartar/cf/vars.yml
      cleanup: true
    get_params:
      skip_export: true
  - task: generate-integration-config
    file: ci/tasks/generate-integration-config/task.yml
    params:
      ADMIN_PASSWORD: ((TARTAR_ADMIN_PASSWORD))
      ADMIN_USER: admin
      API: api.tartar.cf-app.com
      APPS_DOMAIN: tartar.cf-app.com
      UNALLOCATED_IP: 10.0.0.5
      WINDOWS_STACK: windows
  - task: cats
    file: cf-deployment-concourse-tasks/run-cats/task.yml
    params:
      NODES: 4
    on_success:
      task: delete-deployment
      file: ci/tasks/bosh-deld/task.yml
      params:
        BOSH_CA_CERT: ((TARTAR_BOSH_CA_CERT))
        BOSH_CLIENT: ((TARTAR_BOSH_CLIENT))
        BOSH_CLIENT_SECRET: ((TARTAR_BOSH_CLIENT_SECRET))
        BOSH_DEPLOYMENT: cf
        BOSH_ENVIRONMENT: ((TARTAR_BOSH_ENVIRONMENT))
        JUMPBOX_IP: ((TARTAR_JUMPBOX_IP))
        JUMPBOX_SSH_KEY: ((TARTAR_JUMPBOX_SSH_KEY))
  ensure:
    put: tartar-lock-pool
    params:
      release: tartar-lock-pool

- name: tartar-offline-smoke-test
  serial: true
  plan:
  - put: tartar-lock-pool
    params:
      acquire: true
  - in_parallel:
    - get: ci
    - get: windowsfs-release-develop
      passed: [test-create-release-windows, test-create-release-linux]
      trigger: true
    - get: winc-release-master
      trigger: true
    - get: gcp-windows-stemcell
  - in_parallel:
    - task: create-windowsfs-release
      file: ci/tasks/create-fs-release-linux/task.yml
      input_mapping:
        windowsfs-release: windowsfs-release-develop
      output_mapping:
        release-tarball: windowsfs-tarball
    - task: create-winc-release
      file: ci/tasks/bosh-cr/task.yml
      input_mapping:
        release: winc-release-master
      output_mapping:
        release-tarball: winc-tarball
  - task: create-windowsfs-opsfile
    file: ci/tasks/write-windows2016fs-opsfile/task.yml
    params:
      FS_VERSION: ((fs-version))
    input_mapping: { release-tarball: windowsfs-tarball }
  - task: delete-deployments
    file: ci/tasks/bosh-delete-deployments/task.yml
    params:
      BOSH_CA_CERT: ((TARTAR_BOSH_CA_CERT))
      BOSH_CLIENT: ((TARTAR_BOSH_CLIENT))
      BOSH_CLIENT_SECRET: ((TARTAR_BOSH_CLIENT_SECRET))
      BOSH_ENVIRONMENT: ((TARTAR_BOSH_ENVIRONMENT))
      JUMPBOX_IP: ((TARTAR_JUMPBOX_IP))
      JUMPBOX_SSH_KEY: ((TARTAR_JUMPBOX_SSH_KEY))
  - task: delete-stemcells
    file: ci/tasks/bosh-delete-stemcells/task.yml
    params:
      BOSH_CA_CERT: ((TARTAR_BOSH_CA_CERT))
      BOSH_CLIENT: ((TARTAR_BOSH_CLIENT))
      BOSH_CLIENT_SECRET: ((TARTAR_BOSH_CLIENT_SECRET))
      BOSH_DEPLOYMENT: ((fs-version))
      BOSH_ENVIRONMENT: ((TARTAR_BOSH_ENVIRONMENT))
      JUMPBOX_IP: ((TARTAR_JUMPBOX_IP))
      JUMPBOX_SSH_KEY: ((TARTAR_JUMPBOX_SSH_KEY))
  - task: delete-rootfs-release
    file: ci/tasks/bosh-delete-release/task.yml
    params:
      FS_VERSION: ((fs-version))
      BOSH_CA_CERT: ((TARTAR_BOSH_CA_CERT))
      BOSH_CLIENT: ((TARTAR_BOSH_CLIENT))
      BOSH_CLIENT_SECRET: ((TARTAR_BOSH_CLIENT_SECRET))
      BOSH_DEPLOYMENT: cf
      BOSH_ENVIRONMENT: ((TARTAR_BOSH_ENVIRONMENT))
      JUMPBOX_IP: ((TARTAR_JUMPBOX_IP))
      JUMPBOX_SSH_KEY: ((TARTAR_JUMPBOX_SSH_KEY))
  - put: tartar-smoke-test-deployment
    params:
      manifest: windowsfs-release-develop/manifests/smoke-test.yml
      stemcells:
      - gcp-windows-stemcell/*.tgz
      releases:
      - windowsfs-tarball/*.tgz
      - winc-tarball/*.tgz
      ops_files:
      - windowsfs-opsfile/specified-windowsfs-version.yml
      cleanup: true
    get_params:
      skip_export: true
  - task: smoke-test
    file: ci/tasks/fs-smoke-test/task.yml
    params:
      FS_VERSION: ((fs-version))
      BOSH_CA_CERT: ((TARTAR_BOSH_CA_CERT))
      BOSH_CLIENT: ((TARTAR_BOSH_CLIENT))
      BOSH_CLIENT_SECRET: ((TARTAR_BOSH_CLIENT_SECRET))
      BOSH_ENVIRONMENT: ((TARTAR_BOSH_ENVIRONMENT))
      JUMPBOX_IP: ((TARTAR_JUMPBOX_IP))
      JUMPBOX_SSH_KEY: ((TARTAR_JUMPBOX_SSH_KEY))
    on_success:
      task: delete-deployment
      file: ci/tasks/bosh-deld/task.yml
      params:
        BOSH_CA_CERT: ((TARTAR_BOSH_CA_CERT))
        BOSH_CLIENT: ((TARTAR_BOSH_CLIENT))
        BOSH_CLIENT_SECRET: ((TARTAR_BOSH_CLIENT_SECRET))
        BOSH_DEPLOYMENT: ((fs-version))
        BOSH_ENVIRONMENT: ((TARTAR_BOSH_ENVIRONMENT))
        JUMPBOX_IP: ((TARTAR_JUMPBOX_IP))
        JUMPBOX_SSH_KEY: ((TARTAR_JUMPBOX_SSH_KEY))
  ensure:
    put: tartar-lock-pool
    params:
      release: tartar-lock-pool

- name: shipit-offline-major
  serial: true
  plan:
  - in_parallel:
    - get: ci
    - get: windowsfs-release-master
    - get: windowsfs-release-develop
      passed: [tartar-offline-cats, tartar-offline-smoke-test]
    - get: windowsfs-release-version
      params: {bump: major}
  - task: update-version-and-shas
    file: ci/tasks/update-fs-release-version/task.yml
    params:
      FS_VERSION: ((fs-version))
    input_mapping:
      windowsfs-release: windowsfs-release-develop
      version: windowsfs-release-version
  - put: windowsfs-release-master
    params:
      repository: windowsfs-release-updated-version
      tag: windowsfs-release-version/version
      tag_prefix: v
  - put: windowsfs-release-develop
    params:
      repository: windowsfs-release-updated-version
      merge: true
  - task: generate-github-release
    input_mapping:
      release: windowsfs-release-updated-version
      version: windowsfs-release-version
    file: ci/tasks/generate-github-release/task.yml
  - put: windowsfs-release-github-release
    params:
      commitish: generated-release/commitish
      name: generated-release/name
      tag: generated-release/version
  - put: windowsfs-release-version
    params:
      file: windowsfs-release-version/version

- name: shipit-offline-minor
  serial: true
  plan:
  - in_parallel:
    - get: ci
    - get: windowsfs-release-master
    - get: windowsfs-release-develop
      passed: [tartar-offline-cats, tartar-offline-smoke-test]
    - get: windowsfs-release-version
      params: {bump: minor}
  - task: update-version-and-shas
    file: ci/tasks/update-fs-release-version/task.yml
    input_mapping:
      windowsfs-release: windowsfs-release-develop
      version: windowsfs-release-version
  - put: windowsfs-release-master
    params:
      repository: windowsfs-release-updated-version
      tag: windowsfs-release-version/version
      tag_prefix: v
  - put: windowsfs-release-develop
    params:
      repository: windowsfs-release-updated-version
      merge: true
  - task: generate-github-release
    input_mapping:
      release: windowsfs-release-updated-version
      version: windowsfs-release-version
    file: ci/tasks/generate-github-release/task.yml
  - put: windowsfs-release-github-release
    params:
      commitish: generated-release/commitish
      name: generated-release/name
      tag: generated-release/version
  - put: windowsfs-release-version
    params:
      file: windowsfs-release-version/version

- name: shipit-offline-patch
  serial: true
  plan:
  - in_parallel:
    - get: ci
    - get: windowsfs-release-master
    - get: windowsfs-release-develop
      passed: [tartar-offline-cats, tartar-offline-smoke-test]
    - get: windowsfs-release-version
      params: {bump: patch}
  - task: update-version-and-shas
    file: ci/tasks/update-fs-release-version/task.yml
    input_mapping:
      windowsfs-release: windowsfs-release-develop
      version: windowsfs-release-version
  - put: windowsfs-release-master
    params:
      repository: windowsfs-release-updated-version
      tag: windowsfs-release-version/version
      tag_prefix: v
  - put: windowsfs-release-develop
    params:
      repository: windowsfs-release-updated-version
      merge: true
  - task: generate-github-release
    input_mapping:
      release: windowsfs-release-updated-version
      version: windowsfs-release-version
    file: ci/tasks/generate-github-release/task.yml
  - put: windowsfs-release-github-release
    params:
      commitish: generated-release/commitish
      name: generated-release/name
      tag: generated-release/version
  - put: windowsfs-release-version
    params:
      file: windowsfs-release-version/version

- name: tartar-online-cats
  serial: true
  plan:
  - put: tartar-lock-pool
    params:
      acquire: true
  - in_parallel:
    - get: ci
    - get: windowsfs-online-release-develop
      trigger: true
    - get: cf-acceptance-tests
    - get: cf-deployment-concourse-tasks
    - get: cf-deployment
    - get: gcp-windows-stemcell
    - get: garden-windows-environments
  - in_parallel:
    - task: get-linux-stemcell
      file: ci/tasks/get-gcp-linux-stemcell/task.yml
      output_mapping: { stemcell: gcp-linux-stemcell }
    - task: create-windowsfs-release
      file: ci/tasks/bosh-cr/task.yml
      input_mapping:
        release: windowsfs-online-release-develop
      output_mapping:
        release-tarball: windowsfs-tarball
  - task: create-windowsfs-opsfile
    file: ci/tasks/write-windows2016fs-opsfile/task.yml
    params:
      FS_VERSION: ((fs-version))
    input_mapping: { release-tarball: windowsfs-tarball }
  - task: delete-deployments
    file: ci/tasks/bosh-delete-deployments/task.yml
    params:
      BOSH_CA_CERT: ((TARTAR_BOSH_CA_CERT))
      BOSH_CLIENT: ((TARTAR_BOSH_CLIENT))
      BOSH_CLIENT_SECRET: ((TARTAR_BOSH_CLIENT_SECRET))
      BOSH_ENVIRONMENT: ((TARTAR_BOSH_ENVIRONMENT))
      JUMPBOX_IP: ((TARTAR_JUMPBOX_IP))
      JUMPBOX_SSH_KEY: ((TARTAR_JUMPBOX_SSH_KEY))
  - task: delete-stemcells
    file: ci/tasks/bosh-delete-stemcells/task.yml
    params:
      BOSH_CA_CERT: ((TARTAR_BOSH_CA_CERT))
      BOSH_CLIENT: ((TARTAR_BOSH_CLIENT))
      BOSH_CLIENT_SECRET: ((TARTAR_BOSH_CLIENT_SECRET))
      BOSH_DEPLOYMENT: cf
      BOSH_ENVIRONMENT: ((TARTAR_BOSH_ENVIRONMENT))
      JUMPBOX_IP: ((TARTAR_JUMPBOX_IP))
      JUMPBOX_SSH_KEY: ((TARTAR_JUMPBOX_SSH_KEY))
  - put: tartar-cf-deployment
    params:
      manifest: cf-deployment/cf-deployment.yml
      stemcells:
      - gcp-linux-stemcell/*.tgz
      - gcp-windows-stemcell/*.tgz
      releases:
      - windowsfs-tarball/*.tgz
      ops_files:
      - cf-deployment/operations/scale-to-one-az.yml
      - ci/operations/use-2-azs-for-router.yml
      - ((windows-cell-ops-file))
      - ((latest-windows-stemcell-ops-file))
      - ((windows-scale-down-ops-file))
      - ((windows-rdp-ops-file))
      - windowsfs-opsfile/specified-windowsfs-version.yml
      vars_files:
      - garden-windows-environments/tartar/cf/vars.yml
      cleanup: true
    get_params:
      skip_export: true
  - task: generate-integration-config
    file: ci/tasks/generate-integration-config/task.yml
    params:
      ADMIN_PASSWORD: ((TARTAR_ADMIN_PASSWORD))
      ADMIN_USER: admin
      API: api.tartar.cf-app.com
      APPS_DOMAIN: tartar.cf-app.com
      UNALLOCATED_IP: 10.0.0.5
      WINDOWS_STACK: windows
  - task: cats
    file: cf-deployment-concourse-tasks/run-cats/task.yml
    params:
      NODES: 4
    on_success:
      task: delete-deployment
      file: ci/tasks/bosh-deld/task.yml
      params:
        BOSH_CA_CERT: ((TARTAR_BOSH_CA_CERT))
        BOSH_CLIENT: ((TARTAR_BOSH_CLIENT))
        BOSH_CLIENT_SECRET: ((TARTAR_BOSH_CLIENT_SECRET))
        BOSH_DEPLOYMENT: cf
        BOSH_ENVIRONMENT: ((TARTAR_BOSH_ENVIRONMENT))
        JUMPBOX_IP: ((TARTAR_JUMPBOX_IP))
        JUMPBOX_SSH_KEY: ((TARTAR_JUMPBOX_SSH_KEY))
  ensure:
    put: tartar-lock-pool
    params:
      release: tartar-lock-pool

- name: tartar-online-smoke-test
  serial: true
  plan:
  - put: tartar-lock-pool
    params:
      acquire: true
  - in_parallel:
    - get: ci
    - get: windowsfs-online-release-develop
      trigger: true
    - get: winc-release-master
      trigger: true
    - get: gcp-windows-stemcell
  - in_parallel:
    - task: create-windowsfs-release
      file: ci/tasks/bosh-cr/task.yml
      input_mapping:
        release: windowsfs-online-release-develop
      output_mapping:
        release-tarball: windowsfs-tarball
    - task: create-winc-release
      file: ci/tasks/bosh-cr/task.yml
      input_mapping:
        release: winc-release-master
      output_mapping:
        release-tarball: winc-tarball
  - task: create-windowsfs-opsfile
    file: ci/tasks/write-windows2016fs-opsfile/task.yml
    params:
      FS_VERSION: ((fs-version))
    input_mapping: { release-tarball: windowsfs-tarball }
  - task: delete-deployments
    file: ci/tasks/bosh-delete-deployments/task.yml
    params:
      BOSH_CA_CERT: ((TARTAR_BOSH_CA_CERT))
      BOSH_CLIENT: ((TARTAR_BOSH_CLIENT))
      BOSH_CLIENT_SECRET: ((TARTAR_BOSH_CLIENT_SECRET))
      BOSH_ENVIRONMENT: ((TARTAR_BOSH_ENVIRONMENT))
      JUMPBOX_IP: ((TARTAR_JUMPBOX_IP))
      JUMPBOX_SSH_KEY: ((TARTAR_JUMPBOX_SSH_KEY))
  - task: delete-stemcells
    file: ci/tasks/bosh-delete-stemcells/task.yml
    params:
      BOSH_CA_CERT: ((TARTAR_BOSH_CA_CERT))
      BOSH_CLIENT: ((TARTAR_BOSH_CLIENT))
      BOSH_CLIENT_SECRET: ((TARTAR_BOSH_CLIENT_SECRET))
      BOSH_DEPLOYMENT: ((fs-version))
      BOSH_ENVIRONMENT: ((TARTAR_BOSH_ENVIRONMENT))
      JUMPBOX_IP: ((TARTAR_JUMPBOX_IP))
      JUMPBOX_SSH_KEY: ((TARTAR_JUMPBOX_SSH_KEY))
  - put: tartar-smoke-test-deployment
    params:
      manifest: windowsfs-online-release-develop/manifests/smoke-test.yml
      stemcells:
      - gcp-windows-stemcell/*.tgz
      releases:
      - windowsfs-tarball/*.tgz
      - winc-tarball/*.tgz
      ops_files:
      - windowsfs-opsfile/specified-windowsfs-version.yml
      cleanup: true
    get_params:
      skip_export: true
  - task: smoke-test
    file: ci/tasks/fs-smoke-test/task.yml
    params:
      FS_VERSION: ((fs-version))
      BOSH_CA_CERT: ((TARTAR_BOSH_CA_CERT))
      BOSH_CLIENT: ((TARTAR_BOSH_CLIENT))
      BOSH_CLIENT_SECRET: ((TARTAR_BOSH_CLIENT_SECRET))
      BOSH_ENVIRONMENT: ((TARTAR_BOSH_ENVIRONMENT))
      JUMPBOX_IP: ((TARTAR_JUMPBOX_IP))
      JUMPBOX_SSH_KEY: ((TARTAR_JUMPBOX_SSH_KEY))
    on_success:
      task: delete-deployment
      file: ci/tasks/bosh-deld/task.yml
      params:
        BOSH_CA_CERT: ((TARTAR_BOSH_CA_CERT))
        BOSH_CLIENT: ((TARTAR_BOSH_CLIENT))
        BOSH_CLIENT_SECRET: ((TARTAR_BOSH_CLIENT_SECRET))
        BOSH_DEPLOYMENT: ((fs-version))
        BOSH_ENVIRONMENT: ((TARTAR_BOSH_ENVIRONMENT))
        JUMPBOX_IP: ((TARTAR_JUMPBOX_IP))
        JUMPBOX_SSH_KEY: ((TARTAR_JUMPBOX_SSH_KEY))
  ensure:
    put: tartar-lock-pool
    params:
      release: tartar-lock-pool

- name: shipit-online-major
  serial: true
  plan:
  - in_parallel:
    - get: ci
    - get: windowsfs-online-release-develop
      passed: [tartar-online-cats, tartar-online-smoke-test]
    - get: windowsfs-online-release-master
    - get: windowsfs-online-release-version
      params: {bump: major}
  - task: finalize-release
    file: ci/tasks/finalize-release/task.yml
    input_mapping:
      release: windowsfs-online-release-develop
      version: windowsfs-online-release-version
    params:
      RELEASE_NAME: ((fs-version))
      AWS_ACCESS_KEY_ID: ((BOSH_WINDOWS_BOSH_CI_S3_ACCESS_KEY_ID))
      AWS_SECRET_ACCESS_KEY: ((BOSH_WINDOWS_BOSH_CI_S3_SECRET_ACCESS_KEY))
      CI_SKIP: true
  - put: windowsfs-online-release-master
    params:
      repository: finalized-release/release
      tag: windowsfs-online-release-version/number
      tag_prefix: v
  - put: windowsfs-online-release-develop
    params:
      repository: finalized-release/release
      merge: true
  - put: windowsfs-online-release-version
    params: {file: windowsfs-online-release-version/number}
  - task: generate-github-release
    input_mapping:
      release: finalized-repo
      version: windowsfs-online-release-version
    file: ci/tasks/generate-github-release/task.yml
  - put: windowsfs-online-release-github-release
    params:
      commitish: generated-release/commitish
      name: generated-release/name
      tag: generated-release/version
      globs:
      - ((finalized-release-glob))

- name: shipit-online-minor
  serial: true
  plan:
  - in_parallel:
    - get: ci
    - get: windowsfs-online-release-develop
      passed: [tartar-online-cats, tartar-online-smoke-test]
    - get: windowsfs-online-release-master
    - get: windowsfs-online-release-version
      params: {bump: minor}
  - task: finalize-release
    file: ci/tasks/finalize-release/task.yml
    input_mapping:
      release: windowsfs-online-release-develop
      version: windowsfs-online-release-version
    params:
      RELEASE_NAME: ((fs-version))
      AWS_ACCESS_KEY_ID: ((BOSH_WINDOWS_BOSH_CI_S3_ACCESS_KEY_ID))
      AWS_SECRET_ACCESS_KEY: ((BOSH_WINDOWS_BOSH_CI_S3_SECRET_ACCESS_KEY))
      CI_SKIP: true
  - put: windowsfs-online-release-master
    params:
      repository: finalized-release/release
      tag: windowsfs-online-release-version/number
      tag_prefix: v
  - put: windowsfs-online-release-develop
    params:
      repository: finalized-release/release
      merge: true
  - put: windowsfs-online-release-version
    params: {file: windowsfs-online-release-version/number}
  - task: generate-github-release
    input_mapping:
      release: finalized-repo
      version: windowsfs-online-release-version
    file: ci/tasks/generate-github-release/task.yml
  - put: windowsfs-online-release-github-release
    params:
      commitish: generated-release/commitish
      name: generated-release/name
      tag: generated-release/version
      globs:
      - ((finalized-release-glob))

- name: shipit-online-patch
  serial: true
  plan:
  - in_parallel:
    - get: ci
    - get: windowsfs-online-release-develop
      passed: [tartar-online-cats, tartar-online-smoke-test]
    - get: windowsfs-online-release-master
    - get: windowsfs-online-release-version
      params: {bump: patch}
  - task: finalize-release
    file: ci/tasks/finalize-release/task.yml
    input_mapping:
      release: windowsfs-online-release-develop
      version: windowsfs-online-release-version
    params:
      RELEASE_NAME: ((fs-version))
      AWS_ACCESS_KEY_ID: ((BOSH_WINDOWS_BOSH_CI_S3_ACCESS_KEY_ID))
      AWS_SECRET_ACCESS_KEY: ((BOSH_WINDOWS_BOSH_CI_S3_SECRET_ACCESS_KEY))
      CI_SKIP: true
  - put: windowsfs-online-release-master
    params:
      repository: finalized-release/release
      tag: windowsfs-online-release-version/number
      tag_prefix: v
  - put: windowsfs-online-release-develop
    params:
      repository: finalized-release/release
      merge: true
  - put: windowsfs-online-release-version
    params: {file: windowsfs-online-release-version/number}
  - task: generate-github-release
    input_mapping:
      release: finalized-repo
      version: windowsfs-online-release-version
    file: ci/tasks/generate-github-release/task.yml
  - put: windowsfs-online-release-github-release
    params:
      commitish: generated-release/commitish
      name: generated-release/name
      tag: generated-release/version
      globs:
      - ((finalized-release-glob))

groups:
- name: bbl-up
  jobs:
  - bbl-update-hummus
  - bbl-update-tzatziki
  - bbl-update-aioli
  - bbl-update-pesto
  - bbl-update-sriracha
  - bbl-update-guac
- name: deploy-cf
  jobs:
  - deploy-cf-guac
  - deploy-cf-tzatziki
  - deploy-cf-hummus
- name: bbl-down
  jobs:
  - bbl-down-hummus
  - bbl-down-tzatziki
  - bbl-down-aioli
  - bbl-down-pesto
  - bbl-down-sriracha
  - bbl-down-guac

resources:
- name: cf-deployment-concourse-tasks
  type: git
  source:
    branch: master
    uri: https://github.com/cloudfoundry/cf-deployment-concourse-tasks.git

# TODO:
# Del this when https://github.com/cloudfoundry/cf-deployment-concourse-tasks/pull/89 is merged
- name: sophiewigmore-cdct
  type: git
  source:
    branch: delete-deployments
    uri: https://github.com/sophiewigmore/cf-deployment-concourse-tasks.git

- name: cf-deployment
  type: git
  source:
    branch: release-candidate
    uri: https://github.com/cloudfoundry/cf-deployment.git

- name: hummus-lock-pool
  type: pool
  source:
    branch: master
    pool: hummus
    private_key: {{GREENHOUSE-CI_SSH_KEY}}
    uri: git@github.com:greenhouse-ci/locks

- name: guac-lock-pool
  type: pool
  source:
    branch: master
    pool: guac
    private_key: {{GREENHOUSE-CI_SSH_KEY}}
    uri: git@github.com:greenhouse-ci/locks

- name: tzatziki-lock-pool
  type: pool
  source:
    branch: master
    pool: tzatziki
    private_key: {{GREENHOUSE-CI_SSH_KEY}}
    uri: git@github.com:greenhouse-ci/locks

- name: aioli-lock-pool
  type: pool
  source:
    branch: master
    pool: aioli
    private_key: {{GREENHOUSE-CI_SSH_KEY}}
    uri: git@github.com:greenhouse-ci/locks

- name: pesto-lock-pool
  type: pool
  source:
    branch: master
    pool: pesto
    private_key: {{GREENHOUSE-CI_SSH_KEY}}
    uri: git@github.com:greenhouse-ci/locks

- name: sriracha-lock-pool
  type: pool
  source:
    branch: master
    pool: sriracha
    private_key: {{GREENHOUSE-CI_SSH_KEY}}
    uri: git@github.com:greenhouse-ci/locks

- name: garden-windows-environments
  type: git
  source:
    branch: master
    private_key: {{GREENHOUSE-CI_SSH_KEY}}
    uri: git@github.com:pivotal/garden-windows-environments

- name: garden-windows-ci
  type: git
  source:
    branch: master
    uri: https://github.com/cloudfoundry/garden-windows-ci

- name: sunday-morning
  type: time
  source:
    days: [Sunday]
    start: 12:00 AM
    stop: 1:00 AM

jobs:
- name: bbl-update-hummus
  serial: true
  serial_groups: [update]
  plan:
  - put: hummus-lock-pool
    params:
      acquire: true
  - aggregate:
    - get: cf-deployment-concourse-tasks
    - get: garden-windows-environments
    - get: sunday-morning
      trigger: true
  - task: bbl-up
    file: cf-deployment-concourse-tasks/bbl-up/task.yml
    params:
      BBL_IAAS: gcp
      BBL_GCP_SERVICE_ACCOUNT_KEY: {{GARDEN_WINDOWS_DEV_SERVICE_ACCOUNT_JSON}}
      BBL_GCP_REGION: us-east1
      BBL_STATE_DIR: hummus
      BBL_LB_CERT: cert.pem
      BBL_LB_KEY: key.pem
      LB_DOMAIN: hummus.cf-app.com
      BBL_ENV_NAME: hummus
    input_mapping:
      bbl-state: garden-windows-environments
      bbl-config: garden-windows-environments
    ensure:
      do:
      - put: garden-windows-environments
        params:
          repository: updated-bbl-state
          rebase: true
      - put: hummus-lock-pool
        params:
          release: hummus-lock-pool

- name: bbl-update-guac
  serial: true
  serial_groups: [update]
  plan:
  - put: guac-lock-pool
    params:
      acquire: true
  - aggregate:
    - get: cf-deployment-concourse-tasks
    - get: garden-windows-environments
  - task: bbl-up
    file: cf-deployment-concourse-tasks/bbl-up/task.yml
    params:
      BBL_IAAS: aws
      BBL_AWS_ACCESS_KEY_ID: {{GUAC_AWS_ACCESS_KEY_ID}}
      BBL_AWS_SECRET_ACCESS_KEY: {{GUAC_AWS_SECRET_ACCESS_KEY}}
      BBL_AWS_REGION: us-east-1
      BBL_STATE_DIR: guac
      BBL_LB_CERT: certs/cert.pem
      BBL_LB_KEY: certs/key.pem
      LB_DOMAIN: guac.cf-app.com
      BBL_ENV_NAME: guac
    input_mapping:
      bbl-state: garden-windows-environments
      bbl-config: garden-windows-environments
    ensure:
      do:
      - put: garden-windows-environments
        params:
          repository: updated-bbl-state
          rebase: true
      - put: guac-lock-pool
        params:
          release: guac-lock-pool

- name: bbl-update-tzatziki
  serial: true
  serial_groups: [update]
  plan:
  - put: tzatziki-lock-pool
    params:
      acquire: true
  - aggregate:
    - get: cf-deployment-concourse-tasks
    - get: garden-windows-environments
  - task: bbl-up
    file: cf-deployment-concourse-tasks/bbl-up/task.yml
    params:
      BBL_IAAS: gcp
      BBL_GCP_SERVICE_ACCOUNT_KEY: {{GARDEN_WINDOWS_DEV_SERVICE_ACCOUNT_JSON}}
      BBL_GCP_REGION: us-east1
      BBL_STATE_DIR: tzatziki
      BBL_LB_CERT: certs/cert.pem
      BBL_LB_KEY: certs/key.pem
      LB_DOMAIN: tzatziki.cf-app.com
      BBL_ENV_NAME: tzatziki
    input_mapping:
      bbl-state: garden-windows-environments
      bbl-config: garden-windows-environments
    ensure:
      do:
      - put: garden-windows-environments
        params:
          repository: updated-bbl-state
          rebase: true
      - put: tzatziki-lock-pool
        params:
          release: tzatziki-lock-pool

- name: bbl-update-aioli
  serial: true
  serial_groups: [update]
  plan:
  - put: aioli-lock-pool
    params:
      acquire: true
  - aggregate:
    - get: cf-deployment-concourse-tasks
    - get: garden-windows-environments
    - get: sunday-morning
      trigger: true
  - task: bbl-up
    file: cf-deployment-concourse-tasks/bbl-up/task.yml
    params:
      BBL_IAAS: gcp
      BBL_GCP_SERVICE_ACCOUNT_KEY: {{GARDEN_WINDOWS_DEV_SERVICE_ACCOUNT_JSON}}
      BBL_GCP_REGION: us-east1
      BBL_STATE_DIR: aioli
      BBL_LB_CERT: cert.pem
      BBL_LB_KEY: key.pem
      LB_DOMAIN: aioli.cf-app.com
      BBL_ENV_NAME: aioli
    input_mapping:
      bbl-state: garden-windows-environments
      bbl-config: garden-windows-environments
    ensure:
      do:
      - put: garden-windows-environments
        params:
          repository: updated-bbl-state
          rebase: true
      - put: aioli-lock-pool
        params:
          release: aioli-lock-pool

- name: bbl-update-pesto
  serial: true
  serial_groups: [update]
  plan:
  - put: pesto-lock-pool
    params:
      acquire: true
  - aggregate:
    - get: cf-deployment-concourse-tasks
    - get: garden-windows-environments
  - task: bbl-up
    file: cf-deployment-concourse-tasks/bbl-up/task.yml
    params:
      BBL_IAAS: azure
      BBL_AZURE_REGION: "West US"
      BBL_STATE_DIR: pesto
      BBL_LB_CERT: cert.pem
      BBL_LB_KEY: key.pem
      LB_DOMAIN: pesto.cf-app.com
      BBL_ENV_NAME: pesto
    input_mapping:
      bbl-state: garden-windows-environments
      bbl-config: garden-windows-environments
    ensure:
      do:
      - put: garden-windows-environments
        params:
          repository: updated-bbl-state
          rebase: true
      - put: pesto-lock-pool
        params:
          release: pesto-lock-pool

- name: bbl-update-sriracha
  serial: true
  serial_groups: [update]
  plan:
  - put: sriracha-lock-pool
    params:
      acquire: true
  - aggregate:
    - get: cf-deployment-concourse-tasks
    - get: garden-windows-environments
  - task: bbl-up
    file: cf-deployment-concourse-tasks/bbl-up/task.yml
    params:
      BBL_IAAS: gcp
      BBL_GCP_SERVICE_ACCOUNT_KEY: {{GARDEN_WINDOWS_DEV_SERVICE_ACCOUNT_JSON}}
      BBL_GCP_REGION: us-central1
      BBL_STATE_DIR: sriracha
      BBL_LB_CERT: certs/cert.pem
      BBL_LB_KEY: certs/key.pem
      LB_DOMAIN: sriracha.cf-app.com
      BBL_ENV_NAME: sriracha
    input_mapping:
      bbl-state: garden-windows-environments
      bbl-config: garden-windows-environments
    ensure:
      do:
      - put: garden-windows-environments
        params:
          repository: updated-bbl-state
          rebase: true
      - put: sriracha-lock-pool
        params:
          release: sriracha-lock-pool

- name: bbl-down-hummus
  serial: true
  serial_groups: [down]
  plan:
  - put: hummus-lock-pool
    params:
      acquire: true
  - aggregate:
    - get: cf-deployment-concourse-tasks
      resource: sophiewigmore-cdct
    - get: garden-windows-environments
  - task: bosh-delete-all-deployments
    file: cf-deployment-concourse-tasks/bosh-delete-all-deployments/task.yml
    params:
      BBL_STATE_DIR: hummus
    input_mapping:
      bbl-state: garden-windows-environments
    on_failure:
      put: hummus-lock-pool
      params:
        release: hummus-lock-pool
  - task: bbl-down
    file: cf-deployment-concourse-tasks/bbl-destroy/task.yml
    params:
      BBL_GCP_SERVICE_ACCOUNT_KEY: {{GARDEN_WINDOWS_DEV_SERVICE_ACCOUNT_JSON}}
      BBL_STATE_DIR: hummus
    input_mapping:
      bbl-state: garden-windows-environments
    ensure:
      do:
      - put: garden-windows-environments
        params:
          repository: updated-bbl-state
          rebase: true
      - put: hummus-lock-pool
        params:
          release: hummus-lock-pool

- name: bbl-down-tzatziki
  serial: true
  serial_groups: [down]
  plan:
  - put: tzatziki-lock-pool
    params:
      acquire: true
  - aggregate:
    - get: cf-deployment-concourse-tasks
      resource: sophiewigmore-cdct
    - get: garden-windows-environments
  - task: bosh-delete-all-deployments
    file: cf-deployment-concourse-tasks/bosh-delete-all-deployments/task.yml
    params:
      BBL_STATE_DIR: tzatziki
    input_mapping:
      bbl-state: garden-windows-environments
    on_failure:
      put: tzatziki-lock-pool
      params:
        release: tzatziki-lock-pool
  - task: bbl-down
    file: cf-deployment-concourse-tasks/bbl-destroy/task.yml
    params:
      BBL_GCP_SERVICE_ACCOUNT_KEY: {{GARDEN_WINDOWS_DEV_SERVICE_ACCOUNT_JSON}}
      BBL_STATE_DIR: tzatziki
    input_mapping:
      bbl-state: garden-windows-environments
    ensure:
      do:
      - put: garden-windows-environments
        params:
          repository: updated-bbl-state
          rebase: true
      - put: tzatziki-lock-pool
        params:
          release: tzatziki-lock-pool

- name: bbl-down-aioli
  serial: true
  serial_groups: [down]
  plan:
  - put: aioli-lock-pool
    params:
      acquire: true
  - aggregate:
    - get: cf-deployment-concourse-tasks
      resource: sophiewigmore-cdct
    - get: garden-windows-environments
  - task: bosh-delete-all-deployments
    file: cf-deployment-concourse-tasks/bosh-delete-all-deployments/task.yml
    params:
      BBL_STATE_DIR: aioli
    input_mapping:
      bbl-state: garden-windows-environments
    on_failure:
      put: aioli-lock-pool
      params:
        release: aioli-lock-pool
  - task: bbl-down
    file: cf-deployment-concourse-tasks/bbl-destroy/task.yml
    params:
      BBL_GCP_SERVICE_ACCOUNT_KEY: {{GARDEN_WINDOWS_DEV_SERVICE_ACCOUNT_JSON}}
      BBL_STATE_DIR: aioli
    input_mapping:
      bbl-state: garden-windows-environments
    ensure:
      do:
      - put: garden-windows-environments
        params:
          repository: updated-bbl-state
          rebase: true
      - put: aioli-lock-pool
        params:
          release: aioli-lock-pool

- name: bbl-down-pesto
  serial: true
  serial_groups: [down]
  plan:
  - put: pesto-lock-pool
    params:
      acquire: true
  - aggregate:
    - get: cf-deployment-concourse-tasks
      resource: sophiewigmore-cdct
    - get: garden-windows-environments
  - task: bosh-delete-all-deployments
    file: cf-deployment-concourse-tasks/bosh-delete-all-deployments/task.yml
    params:
      BBL_STATE_DIR: pesto
    input_mapping:
      bbl-state: garden-windows-environments
    on_failure:
      put: pesto-lock-pool
      params:
        release: pesto-lock-pool
  - task: bbl-down
    file: cf-deployment-concourse-tasks/bbl-destroy/task.yml
    params:
      BBL_STATE_DIR: pesto
    input_mapping:
      bbl-state: garden-windows-environments
    ensure:
      do:
      - put: garden-windows-environments
        params:
          repository: updated-bbl-state
          rebase: true
      - put: pesto-lock-pool
        params:
          release: pesto-lock-pool

- name: bbl-down-sriracha
  serial: true
  serial_groups: [down]
  plan:
  - put: sriracha-lock-pool
    params:
      acquire: true
  - aggregate:
    - get: cf-deployment-concourse-tasks
      resource: sophiewigmore-cdct
    - get: garden-windows-environments
  - task: bosh-delete-all-deployments
    file: cf-deployment-concourse-tasks/bosh-delete-all-deployments/task.yml
    params:
      BBL_STATE_DIR: sriracha
    input_mapping:
      bbl-state: garden-windows-environments
    on_failure:
      put: sriracha-lock-pool
      params:
        release: sriracha-lock-pool
  - task: bbl-down
    file: cf-deployment-concourse-tasks/bbl-destroy/task.yml
    params:
      BBL_STATE_DIR: sriracha
    input_mapping:
      bbl-state: garden-windows-environments
    ensure:
      do:
      - put: garden-windows-environments
        params:
          repository: updated-bbl-state
          rebase: true
      - put: sriracha-lock-pool
        params:
          release: sriracha-lock-pool

- name: bbl-down-guac
  serial: true
  serial_groups: [down]
  plan:
  - put: guac-lock-pool
    params:
      acquire: true
  - aggregate:
    - get: cf-deployment-concourse-tasks
      resource: sophiewigmore-cdct
    - get: garden-windows-environments
  - task: bosh-delete-all-deployments
    file: cf-deployment-concourse-tasks/bosh-delete-all-deployments/task.yml
    params:
      BBL_STATE_DIR: guac
    input_mapping:
      bbl-state: garden-windows-environments
    on_failure:
      put: guac-lock-pool
      params:
        release: guac-lock-pool
  - task: bbl-down
    file: cf-deployment-concourse-tasks/bbl-destroy/task.yml
    params:
      BBL_AWS_ACCESS_KEY_ID: {{GUAC_AWS_ACCESS_KEY_ID}}
      BBL_AWS_SECRET_ACCESS_KEY: {{GUAC_AWS_SECRET_ACCESS_KEY}}
      BBL_STATE_DIR: guac
    input_mapping:
      bbl-state: garden-windows-environments
    ensure:
      do:
      - put: garden-windows-environments
        params:
          repository: updated-bbl-state
          rebase: true
      - put: guac-lock-pool
        params:
          release: guac-lock-pool

- name: deploy-cf-guac
  serial: true
  plan:
  - put: guac-lock-pool
    params:
      acquire: true
  - aggregate:
    - get: cf-deployment-concourse-tasks
    - get: cf-deployment
    - get: garden-windows-ci
    - get: garden-windows-environments
  - task: collect-garden-windows-ci-ops-files
    file: cf-deployment-concourse-tasks/collect-ops-files/task.yml
    params:
      BASE_OPS_FILE_DIR: guac
      NEW_OPS_FILES: |
        operations/latest-garden-runc.yml
        operations/latest-winc.yml
        operations/enable-rdp-1803.yml
        operations/windows1803-debug.yml
    input_mapping:
      base-ops-files: garden-windows-environments
      new-ops-files: garden-windows-ci
  - task: collect-cf-deployment-ops-files
    file: cf-deployment-concourse-tasks/collect-ops-files/task.yml
    params:
      BASE_OPS_FILE_DIR: guac
      NEW_OPS_FILES: |
        operations/windows1803-cell.yml
        operations/use-latest-windows1803-stemcell.yml
        operations/use-latest-stemcell.yml
        operations/scale-to-one-az.yml
        operations/stop-skipping-tls-validation.yml
    input_mapping:
      base-ops-files: collected-ops-files
      new-ops-files: cf-deployment
  - task: deploy-cf
    file: cf-deployment-concourse-tasks/bosh-deploy/task.yml
    params:
      BBL_STATE_DIR: guac
      SYSTEM_DOMAIN: guac.cf-app.com
      OPS_FILES: |
        guac/windows1803-cell.yml
        guac/use-latest-windows1803-stemcell.yml
        guac/use-latest-stemcell.yml
        guac/scale-to-one-az.yml
        guac/stop-skipping-tls-validation.yml
        guac/latest-garden-runc.yml
        guac/latest-winc.yml
        guac/enable-rdp-1803.yml
        guac/windows1803-debug.yml
      VARS_FILES: guac/cf/vars.yml
    input_mapping:
      bbl-state: garden-windows-environments
      ops-files: collected-ops-files
      vars-files: garden-windows-environments
    ensure:
      put: guac-lock-pool
      params:
        release: guac-lock-pool

- name: deploy-cf-tzatziki
  serial: true
  plan:
  - put: tzatziki-lock-pool
    params:
      acquire: true
  - aggregate:
    - get: cf-deployment-concourse-tasks
    - get: cf-deployment
    - get: garden-windows-ci
    - get: garden-windows-environments
  - task: collect-garden-windows-ci-ops-files
    file: cf-deployment-concourse-tasks/collect-ops-files/task.yml
    params:
      BASE_OPS_FILE_DIR: tzatziki
      NEW_OPS_FILES: |
        operations/latest-garden-runc.yml
        operations/latest-winc.yml
        operations/enable-rdp-2019.yml
        operations/windows2019-debug.yml
    input_mapping:
      base-ops-files: garden-windows-environments
      new-ops-files: garden-windows-ci
  - task: collect-cf-deployment-ops-files
    file: cf-deployment-concourse-tasks/collect-ops-files/task.yml
    params:
      BASE_OPS_FILE_DIR: tzatziki
      NEW_OPS_FILES: |
        operations/windows2019-cell.yml
        operations/use-online-windows2019fs.yml
        operations/use-latest-windows2019-stemcell.yml
        operations/use-latest-stemcell.yml
        operations/scale-to-one-az.yml
        operations/stop-skipping-tls-validation.yml
    input_mapping:
      base-ops-files: collected-ops-files
      new-ops-files: cf-deployment
  - task: deploy-cf
    file: cf-deployment-concourse-tasks/bosh-deploy/task.yml
    params:
      BBL_STATE_DIR: tzatziki
      SYSTEM_DOMAIN: tzatziki.cf-app.com
      OPS_FILES: |
        tzatziki/windows2019-cell.yml
        tzatziki/use-online-windows2019fs.yml
        tzatziki/use-latest-windows2019-stemcell.yml
        tzatziki/use-latest-stemcell.yml
        tzatziki/scale-to-one-az.yml
        tzatziki/stop-skipping-tls-validation.yml
        tzatziki/latest-garden-runc.yml
        tzatziki/latest-winc.yml
        tzatziki/enable-rdp-2019.yml
        tzatziki/windows2019-debug.yml
      VARS_FILES:  tzatziki/cf/vars.yml
    input_mapping:
      bbl-state: garden-windows-environments
      ops-files: collected-ops-files
      vars-files: garden-windows-environments
    ensure:
      put: tzatziki-lock-pool
      params:
        release: tzatziki-lock-pool

- name: deploy-cf-hummus
  serial: true
  plan:
  - put: hummus-lock-pool
    params:
      acquire: true
  - aggregate:
    - get: cf-deployment-concourse-tasks
    - get: cf-deployment
    - get: garden-windows-ci
    - get: garden-windows-environments
  - task: collect-garden-windows-ci-ops-files
    file: cf-deployment-concourse-tasks/collect-ops-files/task.yml
    params:
      BASE_OPS_FILE_DIR: hummus
      NEW_OPS_FILES: |
        operations/latest-garden-runc.yml
        operations/latest-winc.yml
        operations/enable-rdp-2019.yml
        operations/windows2019-debug.yml
    input_mapping:
      base-ops-files: garden-windows-environments
      new-ops-files: garden-windows-ci
  - task: collect-cf-deployment-ops-files
    file: cf-deployment-concourse-tasks/collect-ops-files/task.yml
    params:
      BASE_OPS_FILE_DIR: hummus
      NEW_OPS_FILES: |
        operations/windows2019-cell.yml
        operations/use-online-windows2019fs.yml
        operations/use-latest-windows2019-stemcell.yml
        operations/use-latest-stemcell.yml
        operations/scale-to-one-az.yml
        operations/stop-skipping-tls-validation.yml
    input_mapping:
      base-ops-files: collected-ops-files
      new-ops-files: cf-deployment
  - task: deploy-cf
    file: cf-deployment-concourse-tasks/bosh-deploy/task.yml
    params:
      BBL_STATE_DIR: hummus
      SYSTEM_DOMAIN: hummus.cf-app.com
      OPS_FILES: |
        hummus/windows2019-cell.yml
        hummus/use-online-windows2019fs.yml
        hummus/use-latest-windows2019-stemcell.yml
        hummus/use-latest-stemcell.yml
        hummus/scale-to-one-az.yml
        hummus/stop-skipping-tls-validation.yml
        hummus/latest-garden-runc.yml
        hummus/latest-winc.yml
        hummus/enable-rdp-2019.yml
        hummus/windows2019-debug.yml
      VARS_FILES: hummus/cf/vars.yml
    input_mapping:
      bbl-state: garden-windows-environments
      ops-files: collected-ops-files
      vars-files: garden-windows-environments
    ensure:
      put: hummus-lock-pool
      params:
        release: hummus-lock-pool
